\cref{chapter:nv} concerned a two-qubit approximation of the short-time dynamics of an \gls{nvc}. 
It is valid criticism that the corresponding \gls{model space} searched was reduced substantially through prior knowledge,
    and it therefore remains to test \gls{qmla} in a large model space, on physically meaningful data. 
In this chapter, we extend \gls{qmla} to consider appoximations of \gls{nvc} sytems using more qubits, 
    representing several nuclear sites, which aim to capture the interactions between the 
    target \gls{nvc} and the environment more thoroughly. 
Here we will simulate the target system, allowing us to make definite statements on the performance of \gls{qmla}, 
    unlike the experimental data where we can not be sure of the dynamics' generator.

\par 

\section{Target system}
\begin{figure}
    \begin{center}
        \includegraphics{experimental_study/figures/nv_revival_raw_data.pdf}
    \end{center}
    \caption[Long-time dynamics for \glsentrylong{nvc}]{
        Long-time dynamics for \glsentrylong{nvc}, red, showing revivals, 
            generated by $\ho$ from \cref{eqn:nv_gen_alg_target}, via Hahn echo measurement with $t^{\prime} = t$.
        For comparison, experimentally generated dynamics are shown in blue. 
    }
    \label{fig:nv_revival_raw}
\end{figure}
A realistic model may be expected from considering the environment as a finite-size bath, 
    consisting of $n_s$ nuclear spins in addition to the \gls{nvc} spin, 
    i.e. the total number of qubits of such a model is $n_q = 1 + n_s$.   
The effects of nuclear spins are expected to manifest at higher times than those studied in \cref{chapter:nv}, 
    i.e. the decoherence of the \gls{nvc} is only effected by the nuclear spins' independent precession at high times, 
    so we must modify the experimental procedure accordingly.
Such effects can also be highlighted by Hahn echo measurements, 
    as in \cref{fig:hahn_bloch_spheres}, 
    except reversing the evoluting by $t^{\prime} = t$ instead of $t^{\prime} = 2t$
    \cite{childress2006coherent, breuer2002theory}, so our simulations will use this measurement scheme. 
    % TODO reference that explicitly says Hahn t=t' gives long-time dynamics
\par 

Since we are simulating the target system, we may choose the approximation we wish to invoke. 
To set $\ho$, we use the \emph{secular} approximation, i.e. we assume the magnetic field is perfectly aligned along 
    the $z$-axis \cite{rowan1965electron}:
    recalling \cref{eqn:nv_ham_full}, the \gls{nvc} spin qubit rotates only about the $z$-axis, 
    and coupling between the \gls{nvc} and nuclear qubits are only via $\hat{S}_z \cdot \hat{A}_z^{\chi}$.
Here we will include the effect of the nuclear spins' rotations, which are much weaker and only inluence the \gls{nvc}'s decoherence at long times. 
In total then, the set of nuclear spins, $\{\chi\}$, are mapped to $n_s$ qubits:
\begin{equation}
    \ho = \hat{S}_z 
    + \sum\limits_{ j=2 }^{n_q} \hat{S}_z \cdot \hat{A}_z^{j} 
    + \sum\limits_{w \in \{x,y,z\}} \sum\limits_{ j=2 }^{n_q} \hat{I}_w^{j}.
\end{equation}

For simplicity, we restate this in terms only of the Pauli matrices,
    where the first qubit refers to the \gls{nvc} and the remaining qubits give the interactions and nuclear terms.
\begin{equation}
    \label{eqn:nv_gen_alg_target}
    \ho = \sz^1 
    + \sum\limits_{ j=2 }^{n_q} \sz^1 \sz^j 
    + \sum\limits_{w \in \{x,y,z\}} \sum\limits_{ j=2 }^{n_q} \hat{\sigma}_w^j,
\end{equation}
    so in total, $\termset_0$ has 1 term for the \gls{nvc} qubit, $n_s$ terms for hyperfine couplings
    and $3n_s$ terms for the nuclei: $\absval{\termset_0} = 1 + 4n_s$.
\par 

We set the goal of \gls{qmla} as finding the approximation of \cref{eqn:nv_gen_alg_target},
    by allowing it to consider a wider set of terms. 
The permissible terms are then all spin rotation terms, 
    as well as all nuclei rotation terms, and the coupling terms:
\begin{equation}
    \termset = \left\{ 
        \begin{split}    
            \hat{S}_w &= \hat{\sigma}_w^{1}, \\
            \hat{I}_w^{j} &= \s_w^{j}, \\
            \hat{S}_w \cdot \hat{A}_w &= \s_w^1 \s_w^j
        \end{split}
    \right\}
    \label{eqn:nv_ga_terms}
\end{equation}
    for $w=\{ x, y, z \}$ and $j \in \{ 2, ..., n_q^{\prime} \}$.
Note that $n_s^{\prime}$ is the number of nuclear spins considered by \gls{qmla}, but not necessarily the 
    same number of nuclear spins, $n_s$, present in $\ho$:
    in general $n_s^{\prime}+1 = n_q^{\prime} \neq n_q$.
In total, $\absval{\termset} = 3 + 3n_s^{\prime} + 3 n_s^{\prime} = 3 + 6 n_s^{\prime}$. 
We set the system parameters based on theoretical predictions, listed in \cref{table:nv_gen_alg_term_params}.

\par 

\begin{table}
    \begin{tabular}{cclrr}
        Term & $\hat{t}$ & Meaning & Parameter (Hz) & $ \in \ho$ \\
        \hline
        \\
        $\hat{S}_x$ & $\sx^1$ & \gls{nvc} rotation about $x$-axis & $ 2\times 10^9 $ & No \\
        $\hat{S}_y$ & $\sy^1$ & \gls{nvc} rotation about $y$-axis & $ 2\times 10^9 $ & No \\
        $\hat{S}_z$ & $\sz^1$ & \gls{nvc} rotation about $z$-axis & $ 2\times 10^9 $ & Yes \\
        \\
        $\hat{S}_x \cdot \hat{A}_x^j$ & $\sx^1 \sx^j$ & Coupling b/w spin and $j^{th}$ nuclear qubit about $x$-axis & $ 0.2 \times 10^6 $ & No \\
        $\hat{S}_y \cdot \hat{A}_y^j$ & $\sy^1 \sy^j$ & Coupling b/w spin and $j^{th}$ nuclear qubit about $y$-axis & $ 0.2 \times 10^6 $ & No \\
        $\hat{S}_z \cdot \hat{A}_z^j$ & $\sz^1 \sz^j$ & Coupling b/w spin and $j^{th}$ nuclear qubit about $z$-axis & $ 0.2 \times 10^6 $ & Yes \\
        \\
        $\hat{I}_x^j$ & $\sx^j$ & $j^{th}$ nuclear spin rotation about $x$-axis & $ 66\times 10^3$ & Yes \\
        $\hat{I}_y^j$ & $\sy^j$ & $j^{th}$ nuclear spin rotation about $y$-axis & $ 66\times 10^3 $ & Yes \\
        $\hat{I}_z^j$ & $\sz^j$ & $j^{th}$ nuclear spin rotation about $z$-axis & $ 15\times 10^3 $ & Yes \\
        \hline 
    \end{tabular}
    \caption[Extended model \gls{nvc} terms]{
        Extended model \gls{nvc} terms
    }
    \label{table:nv_gen_alg_term_params}
\end{table}

Our aim is to test \gls{qmla}, so the choice of $n_s$ and $n_s^{\prime}$ are arbitrary; 
    for the target system we use $n_s=4$ proximal spins, 
    so that, from \cref{eqn:nv_gen_alg_target},  $\absval{\termset_0} = 13$,
    and we allow candidates to consider $n_s^{\prime}=5$, 
    so $\absval{\termset} = 33$. 
\par 

In the most general sense, irrespective of the underlying physics we are simulating, 
    here \gls{qmla} is aiming to identify the 13 terms truly present in \gls{q}, 
    while searching the space of 33 permissible terms. 
Without imposing any restrictions on which combinations of terms are allowed, 
    each term is simply either in $\hp$ or not, so can be thought of as binary variables:
    the total \gls{model space} is therefore of size $2^{33} \approx 10^{10}$. 

\section{Genetic algorithm}
\Glspl{ga} provide a robust and thoroughly tested paradigm for searching large candidate spaces; 
    this is a natural framework through which we can explore such an unresetricted model space. 
We have already extensively discussed the formalism of \glspl{ga} in \cref{chapter:ga}, 
    and specifically in the context of \gls{qmla} in \cref{sec:ga_adaptation_to_qmla}.
Here we will use the same \gls{es} as described in \cref{chapter:ga}, 
    i.e. where model generation is driven by a \gls{ga}, 
    and models are cast to chromosomes. 
In particular, candidate model's fitness will be computed from the residuals
    between their and the sytem's dynamics, described fully in \cref{sec:residuals}. 
This \glsentryfull{of} relies on the definition of a validation dataset, $\expset_v$,
    which we compose of tomographic probes and times generated uniformly up to 
    $t_{max} = 100 \mu s$, \cref{fig:nv_ga_eval_data}. 

\begin{figure}
    \begin{center}
        \subfloat{
            \includegraphics[width=0.25\textwidth]{experimental_study/figures/nv_ga_eval_probes.pdf}
        }
        \qquad
        \subfloat{
            \includegraphics{experimental_study/figures/nv_ga_eval_times.pdf}
        }
    \end{center}
    \caption[Evaluation dataset for \glsentrylong{nvc} \glsentrylong{ga}]{
        Evaluation dataset, $\expset_v$, for \glsentrylong{nvc} \glsentrylong{ga}. 
        \textbf{Left}, \Gls{probe} state the \gls{nvc}  qubit is prepared in, on the Bloch sphere, 
            i.e. $\Psi_v$ is close to the tomographic basis. 
        \textbf{Right}, Time comb evaluated against, i.e. uniformly distributed times up to $t_{max} = 100 \mu \textrm{s}$ 
            are used for experiments in $\expset_v$. 
        }
    \label{fig:nv_ga_eval_data}
\end{figure}    

\par 

\subsection{Parameter learning}
Our primary goal in this chapter is to validate \gls{qmla}'s performance in a 
    very large \gls{model space}, with over $10^{10}$ valid candidates. 
Our focus, then, is on model generation, and not concerned with parameter learning:
    we do \emph{not} train models individually, but rather we assume access to a \emph{perfect} parameter learning subroutine.
That is, for each candidate considered, we simply assume knowledge of its parameters, $\al$. 
This assumption is a major caveat to the results of this chapter: 
    no such perfect training scheme is known, 
    so it remains to examine the detrimental effects of imprecisely finding $\al^{\prime} \approx \al$. 
Moreover, while it is possible to extract information on the nuclear qubits from measuring only the 
    \gls{nvc} qubit, as in the Hahn echo measurements, 
    it is uncertain whether any technique can simultaneously detect parameters of significantly varying orders of magnitude.
For instance, some terms in \cref{table:nv_gen_alg_term_params} are $\mathcal{O}(\ghz)$, 
    while others are $\mathcal{O}(\khz)$;
    it is likely to prove difficult to discern the $\khz$ parameters well, given that their contribution is equivalent 
    to errors of order $\mathcal{O}(10^{-6})$ in the dominant $\ghz$ terms. 
Therefore we must caution that the results presented here, 
    while demonstrating that \gls{qmla} \emph{can} operate in large model spaces, 
    are not immediately applicable to experimental systems, 
    since there are outstanding challenges in the assessment of individual candidates, 
    which must be overcome before the technique outlined can realisitcally succeed. 


\subsection{Results}
At the \gls{instance} level, we can see that the gene pool tends towards models of higher quality, 
    captured\footnotemark \ by their $\fs$, \cref{fig:nv_ga_instance}\textbf{a}. 
The improvement in modelling is reflected in the branch champions' predictive power at 
    reproducing data generated by the system, \cref{fig:nv_ga_instance}\textbf{b}. 
\footnotetext{The use of $\fs$ as a figure of merit for candidate models in the \gls{qmla} search is described in \cref{sec:f_score}.}
\begin{figure}
    \begin{center}
        \includegraphics{experimental_study/figures/nv_ga_instance_horiz.pdf}
    \end{center}
    \caption[\Gls{instance} of \glsentrylong{ga} for simulated \glsentrylong{nvc} system with four qubits]{
        \Gls{instance} of the \glsentryfull{ga} for simulated \glsentrylong{nvc} system with four qubits.       
        \textbf{a}, Gene pool progression for the \gls{ga}. Each tile represents a candidate model by its $\fs$. 
        Each generation considers $N_m=72$ models; the \gls{ga} runs for $N_g=53$ generations. 
        \textbf{b}, Branch champions' dynamics. 
        Each generation, $\mu$, nominates a branch champion, $\hat{H}_{C(\mu)}$. 
        Here, progressive generations' champions dynamics are shown against those of the target system, $\ho$ (red). 
    }
    \label{fig:nv_ga_instance}
\end{figure}
\par 

Considering the overall \gls{run}, 
    we see that \gls{qmla} is searching in a vast \gls{model space} where randomly sampled models
    have poor $\fs$ on average, \cref{fig:nv_ga_run_models}\textbf{a}. 
\gls{qmla} efficiently explores the space by quickly moving into a 
    subspace of high $\fs$, nominating $\hp = \ho$ precisely in $85\%$ of instances,
    \cref{fig:nv_ga_run_models}\textbf{b,c}.
The number of times each of the terms considered, \cref{eqn:nv_ga_terms}, 
    are present in $\ho$ offers the most important insight from \gls{qmla}, 
    namely the evidence in favour of each term's presence, 
    which can be used to infer the most likely underlying physics. 
Here, $\hat{t} \in \termset_0$ are found in $\geq 94\%$ of instances, 
    while $\hat{t} \notin \termset_0$ are found in $\leq 11\%$, 
    shown in \cref{fig:nv_ga_hinton} and listed in \cref{table:nv_ga_term_counts}.
Such a discrepency, as well as the \glspl{win rate} for the models, 
    allows for the clear declaration of the model $\ho$ as the favoured representation 
    for the quantum system. 

\begin{figure}
    \begin{center}
        \includegraphics{experimental_study/figures/nv_ga_run_models_by_f.pdf}
    \end{center}
    \caption[\Glsentrylong{nvc} \glsentrylong{ga} \gls{run}]{
        \Glsentrylong{nvc} \glsentrylong{ga} \gls{run}.
        \textbf{(a)}, 
            $\fs$ of $10^6$ samples from the \gls{model space} of $2^{33}\approx10^{10}$ candidate models,
            normally distributed around $f=0.44 \pm 0.12$. 
        \textbf{(b)}, The models explored during the model search of all \glspl{instance} combined, 
            $\{\hat{H}_i\}$, show that \gls{qmla} tends towards stronger models overall, 
            with $f = 0.79 \pm 0.16$ from $\sim 140,000$ chromosomes across the 100 instances, 
            i.e. each \gls{instance} tests $\sim 1400$ distinct models. 
        \textbf{(c)}, Champion models from each instance, showing \gls{qmla} finds strong models 
            in general, and in particular finds the \gls{true model} ($\ho$, with $f=1$) in $85\%$ of cases.
        }
    \label{fig:nv_ga_run_models}
\end{figure}

\begin{figure}
    \begin{center}
        \includegraphics{experimental_study/figures/nv_gen_alg_hinton.pdf}
    \end{center}
    \caption[Hinton diagram of terms found for $4$-qubit \glsentrylong{nvc} model]{
        Hinton diagram of terms found for $4$-qubit \glsentrylong{nvc} model.
        Terms are either in the target model ($\in \termset_0$, blue) or not ($\notin \termset_0$, red), 
        or else not considered ($\notin \termset$, black). 
        Terms acting solely on the first qubit are the \gls{nvc} spin's rotation terms, $\s_w^1$,
            while each nuclear site also has rotation terms $\s_w^j$.
            Hyperfine terms, $\s_w^{(1,j)}$, couple the \gls{nvc} qubit with the $j^{th}$ nuclear spin. 
            The precise rate at which each term is detected can be read from \cref{table:nv_ga_term_counts}. 
        }
    \label{fig:nv_ga_hinton}
\end{figure}

\begin{table}
    \begin{center}
        \input{experimental_study/figures/nv_gen_alg_term_counts.tex}
    \end{center}
    \caption[Percentage of \glspl{instance} for which each term is found by \gls{qmla} \gls{ga} studying \gls{nvc} system]{
        Percentage of \glspl{instance} for which each term is found by \gls{qmla} \gls{ga} studying \gls{nvc} system.
    }
    \label{table:nv_ga_term_counts}
\end{table}